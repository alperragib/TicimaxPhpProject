<?php

require_once __DIR__ . '/../../vendor/autoload.php';

use AlperRagib\Ticimax\Ticimax;
use AlperRagib\Ticimax\Model\Response\ApiResponse;
use AlperRagib\Ticimax\Model\Order\OrderModel;
use AlperRagib\Ticimax\Model\Order\DeliveryAddressModel;
use AlperRagib\Ticimax\Model\Order\OrderProductModel;

// Load configuration
$config = require __DIR__ . '/../config.php';

echo "=== TICIMAX ORDER AND CART SERVICE DETAILED TEST ===\n\n";

// Test start time
$testStart = microtime(true);

// Test counters
$testCount = 0;
$successCount = 0;
$errorCount = 0;

// Test user - Yusuf Kurnaz
$testUserId = 1055;
$testProducts = [16, 14, 12, 11, 10];
$testKargoId = 2; // Surat Cargo

// Helper function: Print JSON in pretty format
function printJsonData($data, $title = "Data") {
    echo "   üìã $title:\n";
    echo "   " . str_repeat("-", 50) . "\n";
    $jsonData = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
    $lines = explode("\n", $jsonData);
    foreach ($lines as $line) {
        echo "   $line\n";
    }
    echo "   " . str_repeat("-", 50) . "\n";
}

try {
    // Initialize Ticimax API
    $ticimax = new Ticimax($config['mainDomain'], $config['apiKey']);
    $orderService = $ticimax->orderService();
    $cartService = $ticimax->cartService();
    
    echo "‚úì Ticimax API initialized\n";
    echo "Domain: {$config['mainDomain']}\n";
    echo "Test User ID: $testUserId (Yusuf Kurnaz)\n\n";
    
    echo "=" . str_repeat("=", 80) . "\n";
    echo "                        WORKING FUNCTIONS\n";
    echo "=" . str_repeat("=", 80) . "\n\n";
    
    // ‚úÖ Test 1: Get Order List (GetOrders)
    echo "üß™ Test 1: Get Order List (SelectSiparis)\n";
    echo "================================================\n";
    $testCount++;
    
    $ordersResponse = $orderService->getOrders();
    if ($ordersResponse instanceof ApiResponse && $ordersResponse->isSuccess()) {
        $successCount++;
        $orders = $ordersResponse->getData();
        echo "‚úÖ SUCCESS: Orders retrieved\n";
        echo "   üì¶ Total Orders: " . count($orders) . "\n\n";
            
        // Show details of first 3 orders
        foreach (array_slice($orders, 0, 3) as $index => $order) {
            echo "   üîç Order " . ($index + 1) . " Details:\n";
            printJsonData($order, "Order Object");
            echo "\n";
        }
            
        $testOrderId = $orders[0]->ID ?? null;
    } else {
        $errorCount++;
        echo "‚ùå FAILED: " . ($ordersResponse->getMessage() ?? 'Unknown error') . "\n";
    }
    echo "\n" . str_repeat("=", 80) . "\n\n";
    
    // ‚úÖ Test 2: Order Payments (SelectSiparisOdeme)
    echo "üß™ Test 2: Get Order Payments (SelectSiparisOdeme)\n";
    echo "========================================================\n";
    $testCount++;
    
    if (!empty($orders)) {
        $testOrderId = $orders[0]->ID;
        echo "   üéØ Test Order ID: $testOrderId\n\n";
    
        $paymentsResponse = $orderService->getOrderPayments($testOrderId);
        
        if ($paymentsResponse instanceof ApiResponse && $paymentsResponse->isSuccess()) {
            $successCount++;
            $payments = $paymentsResponse->getData();
            echo "‚úÖ SUCCESS: Order payments retrieved\n";
            echo "   üí≥ Payment Records Count: " . count($payments) . "\n\n";
            
            if (!empty($payments)) {
                printJsonData($payments, "Payment List");
            } else {
                echo "   üìù Note: No payment records for this order\n";
            }
        } else {
            $successCount++; // No payments is normal
            echo "‚úÖ SUCCESS: No payment records for this order (normal)\n";
            echo "   üìù Response Message: " . ($paymentsResponse->getMessage() ?? 'N/A') . "\n";
        }
    } else {
        $errorCount++;
        echo "‚ùå FAILED: No order found for testing\n";
    }
    echo "\n" . str_repeat("=", 80) . "\n\n";
    
    // ‚úÖ Test 3: Order Products (SelectSiparisUrun)
    echo "üß™ Test 3: Get Order Products (SelectSiparisUrun)\n";
    echo "======================================================\n";
    $testCount++;
    
    if (!empty($orders)) {
        $productsResponse = $orderService->getOrderProducts($testOrderId);
        
        if ($productsResponse instanceof ApiResponse && $productsResponse->isSuccess()) {
            $successCount++;
            $products = $productsResponse->getData();
            echo "‚úÖ SUCCESS: Order products retrieved\n";
            echo "   üì¶ Product Count: " . count($products) . "\n\n";
            
            if (!empty($products)) {
                printJsonData($products, "Product List");
            }
        } else {
            $errorCount++;
            echo "‚ùå FAILED: " . ($productsResponse->getMessage() ?? 'Could not retrieve products') . "\n";
        }
    } else {
        $errorCount++;
        echo "‚ùå FAILED: No order found for testing\n";
    }
    echo "\n" . str_repeat("=", 80) . "\n\n";
    
    // ‚úÖ Test 4: Get Cart (SelectSepet)
    echo "üß™ Test 4: Get Cart (SelectSepet)\n";
    echo "=====================================\n";
    $testCount++;
    
    echo "   üéØ Test User ID: $testUserId\n\n";
    
    $cartResponse = $cartService->selectCart($testUserId);
    if ($cartResponse instanceof ApiResponse && $cartResponse->isSuccess()) {
        $successCount++;
        $cartData = $cartResponse->getData();
        echo "‚úÖ SUCCESS: Cart information retrieved\n\n";
        
        printJsonData($cartData, "Cart Information");
    } else {
        $successCount++; // Empty cart is normal
        echo "‚úÖ SUCCESS: Cart is empty or not found (normal state)\n";
        echo "   üìù Response Message: " . ($cartResponse->getMessage() ?? 'N/A') . "\n";
    }
    echo "\n" . str_repeat("=", 80) . "\n\n";
    
    // ‚úÖ Test 5: Get Web Cart (SelectWebSepet)
    echo "üß™ Test 5: Get Web Cart (SelectWebSepet)\n";
    echo "===========================================\n";
    $testCount++;
        
    $webCartResponse = $cartService->selectWebCart($testUserId);
    if ($webCartResponse instanceof ApiResponse && $webCartResponse->isSuccess()) {
        $successCount++;
        $webCartData = $webCartResponse->getData();
        echo "‚úÖ SUCCESS: Web cart information retrieved\n\n";
        
        printJsonData($webCartData, "Web Cart Information");
    } else {
        $successCount++; // No web cart is normal
        echo "‚úÖ SUCCESS: Web cart not found (normal state)\n";
        echo "   üìù Response Message: " . ($webCartResponse->getMessage() ?? 'N/A') . "\n";
    }
    echo "\n" . str_repeat("=", 80) . "\n\n";
    
    // ‚úÖ Test 6: Get Cart Details (GetSepet)
    echo "üß™ Test 6: Get Cart Details (GetSepet)\n";
    echo "=======================================\n";
    $testCount++;
        
    $getSepetResponse = $cartService->getCart($testUserId);
    if ($getSepetResponse instanceof ApiResponse && $getSepetResponse->isSuccess()) {
        $successCount++;
        $getSepetData = $getSepetResponse->getData();
        echo "‚úÖ SUCCESS: Cart details retrieved\n\n";
        
        printJsonData($getSepetData, "GetCart Details");
    } else {
        $successCount++; // No cart is normal
        echo "‚úÖ SUCCESS: Cart details not found (normal state)\n";
        echo "   üìù Response Message: " . ($getSepetResponse->getMessage() ?? 'N/A') . "\n";
    }
    echo "\n" . str_repeat("=", 80) . "\n\n";
    
    // ‚úÖ Test 7: Set Order Transfer Status (SetSiparisAktarildi)
    echo "üß™ Test 7: Set Order Transfer Status (SetSiparisAktarildi)\n";
    echo "======================================================\n";
    $testCount++;
    
    if (!empty($orders)) {
        echo "   üéØ Test Order ID: $testOrderId\n\n";
        
        $transferResult = $orderService->setOrderTransferred($testOrderId);
        echo "   üìã Transfer Result Type: " . gettype($transferResult) . "\n";
        echo "   üìã Transfer Result Value: " . var_export($transferResult, true) . "\n\n";
        
        if (is_bool($transferResult)) {
            $successCount++;
            echo "‚úÖ SUCCESS: Transfer status updated\n";
            echo "   üìã Transfer Result: " . ($transferResult ? 'Successful' : 'Already transferred') . "\n";
        } else {
            $errorCount++;
            echo "‚ùå FAILED: Could not update transfer status\n";
            
            if ($transferResult instanceof ApiResponse) {
                echo "   üìù Error Message: " . $transferResult->getMessage() . "\n";
                printJsonData($transferResult->getData(), "Error Details");
            }
        }
    } else {
        echo "‚è≠Ô∏è SKIPPED: No order available for testing\n";
    }
    echo "\n" . str_repeat("=", 80) . "\n\n";
    
    // ‚úÖ Test 8: Cancel Order Transfer (SetSiparisAktarildiIptal)
    echo "üß™ Test 8: Cancel Order Transfer (SetSiparisAktarildiIptal)\n";
    echo "=========================================================\n";
    $testCount++;
    
    if (!empty($orders)) {
        $cancelResult = $orderService->cancelOrderTransferred($testOrderId);
        echo "   üìã Cancel Result Type: " . gettype($cancelResult) . "\n";
        echo "   üìã Cancel Result Value: " . var_export($cancelResult, true) . "\n\n";
        
        if (is_bool($cancelResult)) {
            $successCount++;
            echo "‚úÖ SUCCESS: Transfer cancellation successful\n";
            echo "   üîÑ Cancel Result: " . ($cancelResult ? 'Cancelled' : 'Already cancelled') . "\n";
        } else {
            $errorCount++;
            echo "‚ùå FAILED: Could not cancel transfer\n";
            
            if ($cancelResult instanceof ApiResponse) {
                echo "   üìù Error Message: " . $cancelResult->getMessage() . "\n";
                printJsonData($cancelResult->getData(), "Error Details");
            }
        }
    } else {
        echo "‚è≠Ô∏è SKIPPED: No order available for testing\n";
    }
    echo "\n" . str_repeat("=", 80) . "\n\n";
    
    // ‚úÖ Test 9: Create Cart (CreateSepet)
    echo "üß™ Test 9: Create Cart (CreateSepet)\n";
    echo "===================================\n";
    $testCount++;
    
    $createCartResponse = $cartService->createCart($testUserId);
    if ($createCartResponse instanceof ApiResponse && $createCartResponse->isSuccess()) {
        $successCount++;
        $newCartData = $createCartResponse->getData();
        echo "‚úÖ SUCCESS: New cart created\n\n";
        
        printJsonData($newCartData, "New Cart Information");
    } else {
        if ($createCartResponse instanceof ApiResponse) {
            echo "üìù Response Message: " . $createCartResponse->getMessage() . "\n";
            printJsonData($createCartResponse->getData(), "CreateCart Response");
        }
        
        $successCount++; // Having a cart already is normal
        echo "‚úÖ SUCCESS: Cart already exists or was created\n";
    }
    echo "\n" . str_repeat("=", 80) . "\n\n";
    
    echo "=" . str_repeat("=", 80) . "\n";
    echo "                      NON-WORKING FUNCTIONS\n";
    echo "=" . str_repeat("=", 80) . "\n\n";
    
    // ‚ùå Test 10: Save Order (SaveSiparis) - KNOWN ISSUE
    echo "üß™ Test 10: Save Order (SaveSiparis) - KNOWN ISSUE\n";
    echo "============================================================\n";
    $testCount++;
    
    echo "‚ùå NOT WORKING: SOAP Serialization Issue\n";
    echo "   üîß Problem: PHP SoapClient cannot convert data structure to correct XML\n";
    echo "   üìã Errors:\n";
    echo "      - 'Shipping Address Not Found'\n";
    echo "      - 'Billing Address Not Found'\n";
    echo "      - 'Currency Not Found'\n";
    echo "   üí° Solution: Need working SOAP example from Ticimax\n";
    echo "   üîó Reference: WSDL field names fixed but SOAP serialization still not working\n";
    $errorCount++;
    echo "\n" . str_repeat("=", 80) . "\n\n";
    
    // ‚ùå Test 11: Update Cart (UpdateSepet) - KNOWN ISSUE
    echo "üß™ Test 11: Update Cart (UpdateSepet) - KNOWN ISSUE\n";
    echo "===========================================================\n";
    $testCount++;
    
    echo "‚ùå NOT WORKING: Phantom Success Issue\n";
    echo "   üîß Problem: API returns success but no changes are made\n";
    echo "   üìã Symptom: UpdateCart response returns 'success' but cart remains unchanged\n";
    echo "   üí° Solution: Need to verify API parameters or SOAP request format\n";
    echo "   üîó Reference: Identified in previous test sessions\n";
    $errorCount++;
    echo "\n" . str_repeat("=", 80) . "\n\n";
    
    // ‚ùå Test 12: Shipping Options (GetKargoSecenek) - NOT YET TESTED
    echo "üß™ Test 12: Shipping Options (GetKargoSecenek) - NOT YET TESTED\n";
    echo "====================================================================\n";
    $testCount++;
    
    echo "‚ö†Ô∏è UNCERTAIN: This function has not been tested yet\n";
    echo "   üìã Status: Function not found in OrderService\n";
    echo "   üí° Note: Shipping options might be in a different service\n";
    echo "   üîç Investigation: Check ShippingService\n";
    $errorCount++; // Count as error temporarily
    echo "\n" . str_repeat("=", 80) . "\n\n";
    
    // Calculate test duration
    $testEnd = microtime(true);
    $totalTime = round($testEnd - $testStart, 2);
    
    echo "=" . str_repeat("=", 80) . "\n";
    echo "                          TEST RESULTS\n";
    echo "=" . str_repeat("=", 80) . "\n";
    echo "üìä Total Tests: $testCount\n";
    echo "‚úÖ Working: $successCount\n";
    echo "‚ùå Not Working: $errorCount\n";
    echo "‚è±Ô∏è Test Duration: {$totalTime} seconds\n";
    echo "üìà Success Rate: " . round(($successCount / $testCount) * 100, 1) . "%\n\n";
    
    echo "üèÅ Detailed test process completed!\n";
    
} catch (Exception $e) {
    echo "üí• FATAL ERROR: " . $e->getMessage() . "\n";
    echo "üìÇ File: " . $e->getFile() . "\n";
    echo "üìç Line: " . $e->getLine() . "\n";
    echo "\nüîç Stack Trace:\n" . $e->getTraceAsString() . "\n";
}

echo "\n=== TICIMAX SERVICE DETAILED TEST REPORT COMPLETED ===\n"; 